name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Prevents multiple runs on the same branch from colliding on ports
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: docker.io
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/smartsplit-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/smartsplit-frontend
  # Common versions
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

defaults:
  run:
    shell: powershell

jobs:
  # ------------------------------------------------------------------
  # JOB 1: UNIT TESTS (Fast feedback)
  # ------------------------------------------------------------------
  unit-test:
    name: Unit Tests
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      - name: Test Backend
        working-directory: ./backend
        run: mvn test "-Dapp.jwt.secret=${{ secrets.APP_JWT_SECRET }}"

  # ------------------------------------------------------------------
  # JOB 2: E2E TESTS (Complex Integration)
  # ------------------------------------------------------------------
  e2e-test:
    name: E2E Tests
    runs-on: self-hosted
    needs: unit-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- SETUP ---
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # --- AGGRESSIVE CLEANUP (FIXED) ---
      - name: Pre-flight Cleanup
        run: |
          Write-Host "Cleaning up ports 3307, 16048, 3003..."
          $ports = @(3307, 16048, 3003)
          foreach ($port in $ports) {
             $pids = Get-NetTCPConnection -LocalPort $port -ErrorAction SilentlyContinue | Select-Object -ExpandProperty OwningProcess
             foreach ($p in $pids) { Stop-Process -Id $p -Force -ErrorAction SilentlyContinue }
          }
          
          # FIXED: Check if container exists before removing to avoid PowerShell error
          if (docker ps -a -q -f name=mysql-ci) { 
              Write-Host "Removing existing mysql-ci container..."
              docker rm -f mysql-ci 
          }
          
          # FIXED: Check if network exists before removing
          if (docker network ls -q -f name=smartsplit-ci-network) { 
              Write-Host "Removing existing network..."
              docker network rm smartsplit-ci-network 
          }

      # --- INFRASTRUCTURE ---
      - name: Start Database (Docker)
        run: |
          docker network create smartsplit-ci-network
          # We map to 3307 to avoid conflict with standard MySQL
          docker run -d --name mysql-ci --network smartsplit-ci-network `
            -e MYSQL_ROOT_PASSWORD=rootpassword `
            -e MYSQL_DATABASE=smartsplit-db `
            -p "3307:3306" `
            --health-cmd='mysqladmin ping -h localhost -u root -prootpassword --silent' `
            --health-interval=10s --health-retries=5 `
            mysql:8.0

      - name: Build Backend (Skip Tests)
        working-directory: ./backend
        # We skip tests here because we ran them in job 1, saves time & config issues
        run: mvn clean package -DskipTests

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci --legacy-peer-deps

      # --- START SERVICES ---
      - name: Start Application Stack
        env:
          APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}
        run: |
          npm install -g wait-on
          
          # 1. Start Backend in Background
          $jar = Get-ChildItem ./backend/target/*.jar | Where-Object { $_.Name -notlike "*original*" } | Select-Object -First 1
          Write-Host "Starting Backend JAR: $jar"
          
          $backendProcess = Start-Process -FilePath "java" -ArgumentList "-jar", "$jar", "--spring.datasource.url=jdbc:mysql://localhost:3307/smartsplit-db", "--spring.datasource.username=root", "--spring.datasource.password=rootpassword", "--server.port=16048", "--app.jwt.secret=$env:APP_JWT_SECRET" -PassThru -NoNewWindow
          "BACKEND_PID=$($backendProcess.Id)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # 2. Start Frontend in Background
          Write-Host "Starting Frontend..."
          Set-Location ./frontend
          $env:PORT=3003
          $env:BROWSER="none"
          $frontendProcess = Start-Process -FilePath "npm" -ArgumentList "start" -PassThru -NoNewWindow
          "FRONTEND_PID=$($frontendProcess.Id)" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Wait for Services
        timeout-minutes: 5
        run: |
          Write-Host "Waiting for Backend (16048) and Frontend (3003)..."
          # Wait-on handles the polling logic efficiently
          npx wait-on tcp:16048 tcp:3003 --timeout 300000

      # --- TEST EXECUTION ---
      - name: Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: ./frontend
          install: false # Already installed
          start: false   # Already started manually
          wait-on: 'http://localhost:3003'
          browser: chrome
        env:
          CYPRESS_BASE_URL: http://localhost:3003

      # --- ARTIFACTS ---
      - name: Upload Artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-evidence
          path: |
            frontend/cypress/screenshots
            frontend/cypress/videos
          if-no-files-found: ignore

      # --- TEARDOWN (FIXED) ---
      - name: Teardown
        if: always()
        run: |
          if ($env:BACKEND_PID) { Stop-Process -Id $env:BACKEND_PID -Force -ErrorAction SilentlyContinue }
          if ($env:FRONTEND_PID) { Stop-Process -Id $env:FRONTEND_PID -Force -ErrorAction SilentlyContinue }
          
          # FIXED: Conditional Docker cleanup to prevent exit code 1
          if (docker ps -a -q -f name=mysql-ci) { docker rm -f mysql-ci }
          if (docker network ls -q -f name=smartsplit-ci-network) { docker network rm smartsplit-ci-network }
          
          # Final aggressive cleanup
          Get-NetTCPConnection -LocalPort 3307,16048,3003 -ErrorAction SilentlyContinue | ForEach-Object { Stop-Process -Id $_.OwningProcess -Force -ErrorAction SilentlyContinue }

  # ------------------------------------------------------------------
  # JOB 3: BUILD & DEPLOY
  # ------------------------------------------------------------------
  build-and-deploy:
    name: Build & Deploy
    needs: [unit-test, e2e-test]
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Images
        env:
          SHA: ${{ github.sha }}
        run: |
          # Build Backend
          docker build -t "${{ env.BACKEND_IMAGE }}:latest" -t "${{ env.BACKEND_IMAGE }}:${{ env.SHA }}" ./backend
          docker push "${{ env.BACKEND_IMAGE }}:latest"
          docker push "${{ env.BACKEND_IMAGE }}:${{ env.SHA }}"

          # Build Frontend
          docker build -t "${{ env.FRONTEND_IMAGE }}:latest" -t "${{ env.FRONTEND_IMAGE }}:${{ env.SHA }}" ./frontend
          docker push "${{ env.FRONTEND_IMAGE }}:latest"
          docker push "${{ env.FRONTEND_IMAGE }}:${{ env.SHA }}"

      - name: Deploy to Kubernetes
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          $sha = "${{ github.sha }}"
          
          # Update Images
          kubectl set image deployment/backend backend="${{ env.BACKEND_IMAGE }}:$sha" -n smartsplit
          kubectl set image deployment/frontend frontend="${{ env.FRONTEND_IMAGE }}:$sha" -n smartsplit
          
          # Force rollout via annotation
          kubectl patch deployment backend -n smartsplit -p "{`"spec`":{`"template`":{`"metadata`":{`"annotations`":{`"deployment.kubernetes.io/revision-time`":`"$timestamp`"}}}}}"
          kubectl patch deployment frontend -n smartsplit -p "{`"spec`":{`"template`":{`"metadata`":{`"annotations`":{`"deployment.kubernetes.io/revision-time`":`"$timestamp`"}}}}}"
          
          # Wait for status
          kubectl rollout status deployment/backend -n smartsplit --timeout=300s
          kubectl rollout status deployment/frontend -n smartsplit --timeout=300s