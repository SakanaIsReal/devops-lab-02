name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: docker.io
  BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/smartsplit-backend
  FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/smartsplit-frontend

jobs:
  test:
    runs-on: self-hosted
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'  # Updated from 18 to 20
        
    - name: Install Frontend Dependencies
      working-directory: ./frontend
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
        Remove-Item package-lock.json -ErrorAction SilentlyContinue
        npm install --legacy-peer-deps
        npm install --save-dev --legacy-peer-deps @types/jest @testing-library/jest-dom @testing-library/react @testing-library/user-event jest
        
    - name: Install Cypress
      working-directory: ./frontend
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        npm install cypress --save-dev
        
    - name: Run Backend Unit Tests
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      env:
        APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}
        SPRING_PROFILES_ACTIVE: test
      run: |
        cd backend
        $jwtSecret = $env:APP_JWT_SECRET
        mvn test "-Dapp.jwt.secret=$jwtSecret" -DskipITs=true

  e2e-test:
    runs-on: self-hosted
    name: Run E2E Tests
    needs: test

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'

    - name: Install Root Dependencies (Cypress)
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        npm install

    - name: Cleanup Previous Containers
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        Write-Host "Cleaning up previous test environment..."

        # Stop all Java and Node processes from previous runs
        Get-Process | Where-Object {$_.Path -like "*java*" -or $_.Path -like "*node*"} | Stop-Process -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2

        # Force stop and remove MySQL container if it exists
        $mysqlContainer = docker ps -aq -f name=mysql-ci
        if ($mysqlContainer) {
          Write-Host "Stopping and removing mysql-ci container..."
          docker stop mysql-ci -t 0 2>$null
          docker rm -f mysql-ci 2>$null
          Start-Sleep -Seconds 2
        }

        # Remove network if it exists
        $network = docker network ls -q -f name=smartsplit-ci-network
        if ($network) {
          Write-Host "Removing smartsplit-ci-network..."
          docker network rm smartsplit-ci-network 2>$null
        }

        # Kill any processes using critical ports (MySQL: 3307, Backend: 16048, Frontend: 3000)
        $ports = @(3307, 16048, 3000)
        foreach ($port in $ports) {
          $processOnPort = netstat -ano | Select-String ":$port" | Select-String "LISTENING"
          if ($processOnPort) {
            $processOnPort | ForEach-Object {
              $line = $_.Line -split '\s+'
              $pid = $line[-1]
              if ($pid -match '^\d+$' -and $pid -ne 0 -and $pid -ne 4) {
                Write-Host "Killing process $pid using port ${port}..."
                Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
              }
            }
          }
        }
        Start-Sleep -Seconds 2

        Write-Host "Cleanup completed"

    - name: Start MySQL Database
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        Write-Host "Creating Docker network..."
        docker network create smartsplit-ci-network 2>$null
        if ($LASTEXITCODE -eq 0) {
          Write-Host "Network created successfully"
        } else {
          Write-Host "Network might already exist (ignored)"
        }

        Write-Host "Starting MySQL container..."
        docker run -d `
          --name mysql-ci `
          --network smartsplit-ci-network `
          -e MYSQL_ROOT_PASSWORD=rootpassword `
          -e MYSQL_DATABASE=smartsplit-db `
          -p 3307:3306 `
          mysql:8.0

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to start MySQL container"
          exit 1
        }

        Write-Host "Waiting for MySQL to be ready..."
        Start-Sleep -Seconds 30

        # Verify MySQL is responding
        $maxAttempts = 10
        $attempt = 0
        while ($attempt -lt $maxAttempts) {
          $result = docker exec mysql-ci mysqladmin ping -h localhost -u root -prootpassword 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "MySQL is ready"
            break
          }
          $attempt++
          Write-Host "Waiting for MySQL to respond... (Attempt $attempt/$maxAttempts)"
          Start-Sleep -Seconds 3
        }
        if ($attempt -eq $maxAttempts) {
          Write-Error "MySQL failed to become ready"
          exit 1
        }

    - name: Build and Start Backend
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      env:
        APP_JWT_SECRET: ${{ secrets.APP_JWT_SECRET }}
      run: |
        cd backend
        mvn clean package -DskipTests
        Start-Process powershell -ArgumentList "-Command", "java -jar target/*.jar --spring.datasource.url=jdbc:mysql://localhost:3307/smartsplit-db --spring.datasource.username=root --spring.datasource.password=rootpassword --app.jwt.secret=$env:APP_JWT_SECRET --server.port=16048" -WindowStyle Hidden
        Start-Sleep -Seconds 20

    - name: Install Frontend Dependencies
      working-directory: ./frontend
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        npm install --legacy-peer-deps

    - name: Start Frontend
      working-directory: ./frontend
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        Start-Process powershell -ArgumentList "-Command", "npm start" -WindowStyle Hidden
        Start-Sleep -Seconds 30

    - name: Wait for Services
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $maxAttempts = 30
        $attempt = 0
        while ($attempt -lt $maxAttempts) {
          try {
            $response = Invoke-WebRequest -Uri http://localhost:3000 -UseBasicParsing -TimeoutSec 5
            if ($response.StatusCode -eq 200) {
              Write-Host "Frontend is ready"
              break
            }
          } catch {
            $attempt++
            Write-Host "Waiting for frontend... (Attempt $attempt/$maxAttempts)"
            Start-Sleep -Seconds 5
          }
        }
        $attempt = 0
        while ($attempt -lt $maxAttempts) {
          try {
            $response = Invoke-WebRequest -Uri http://localhost:16048/api/actuator/health -UseBasicParsing -TimeoutSec 5
            if ($response.StatusCode -eq 200) {
              Write-Host "Backend is ready"
              break
            }
          } catch {
            $attempt++
            Write-Host "Waiting for backend... (Attempt $attempt/$maxAttempts)"
            Start-Sleep -Seconds 5
          }
        }

    - name: Run Cypress E2E Tests
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      env:
        CYPRESS_BASE_URL: http://localhost:3000
      run: |
        npx cypress run --headless --browser chrome

    - name: Upload Cypress Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: cypress/screenshots
        if-no-files-found: ignore

    - name: Upload Cypress Videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-videos
        path: cypress/videos
        if-no-files-found: ignore

    - name: Cleanup
      if: always()
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        Write-Host "Final cleanup..."

        # Stop all Java and Node processes
        Get-Process | Where-Object {$_.Path -like "*java*" -or $_.Path -like "*node*"} | Stop-Process -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2

        # Force stop and remove MySQL container
        $mysqlContainer = docker ps -aq -f name=mysql-ci
        if ($mysqlContainer) {
          Write-Host "Stopping and removing mysql-ci container..."
          docker stop mysql-ci -t 0 2>$null
          docker rm -f mysql-ci 2>$null
        }

        # Remove network
        $network = docker network ls -q -f name=smartsplit-ci-network
        if ($network) {
          Write-Host "Removing smartsplit-ci-network..."
          docker network rm smartsplit-ci-network 2>$null
        }

        # Kill any remaining processes on critical ports
        $ports = @(3307, 16048, 3000)
        foreach ($port in $ports) {
          $processOnPort = netstat -ano | Select-String ":$port" | Select-String "LISTENING"
          if ($processOnPort) {
            $processOnPort | ForEach-Object {
              $line = $_.Line -split '\s+'
              $pid = $line[-1]
              if ($pid -match '^\d+$' -and $pid -ne 0 -and $pid -ne 4) {
                Write-Host "Killing remaining process $pid on port ${port}..."
                Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue
              }
            }
          }
        }

        Write-Host "Cleanup finished"

  build-and-push:
    runs-on: self-hosted
    name: Build and Push Docker Images
    needs: [test, e2e-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify Docker is Running
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $maxAttempts = 10
        $attempt = 0
        while ($attempt -lt $maxAttempts) {
          try {
            docker info | Out-Null
            Write-Host "Docker is running"
            break
          } catch {
            $attempt++
            Write-Host "Waiting for Docker to start... (Attempt $attempt/$maxAttempts)"
            Start-Sleep -Seconds 5
          }
        }
        if ($attempt -eq $maxAttempts) {
          Write-Error "Docker failed to start"
          exit 1
        }
      
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build Backend Image
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $backendImage = "${{ env.BACKEND_IMAGE }}"
        $gitSha = "${{ github.sha }}"
        # Build with dual tags: :latest (convenience) and :${gitSha} (immutable, used in deployments)
        docker build -t "${backendImage}:latest" -t "${backendImage}:${gitSha}" ./backend
        
    - name: Build Frontend Image
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $frontendImage = "${{ env.FRONTEND_IMAGE }}"
        $gitSha = "${{ github.sha }}"
        # Build with dual tags: :latest (convenience) and :${gitSha} (immutable, used in deployments)
        docker build -t "${frontendImage}:latest" -t "${frontendImage}:${gitSha}" ./frontend
        
    - name: Push Backend to Docker Hub
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $backendImage = "${{ env.BACKEND_IMAGE }}"
        $gitSha = "${{ github.sha }}"
        docker push "${backendImage}:latest"
        docker push "${backendImage}:${gitSha}"
        
    - name: Push Frontend to Docker Hub
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $frontendImage = "${{ env.FRONTEND_IMAGE }}"
        $gitSha = "${{ github.sha }}"
        docker push "${frontendImage}:latest"
        docker push "${frontendImage}:${gitSha}"

  deploy:
    needs: build-and-push
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Update Kubernetes Deployments
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        $backendImage = "${{ env.BACKEND_IMAGE }}"
        $frontendImage = "${{ env.FRONTEND_IMAGE }}"
        $gitSha = "${{ github.sha }}"

        # Use git SHA for immutable deployments instead of :latest
        kubectl set image deployment/backend backend="${backendImage}:${gitSha}" -n smartsplit
        kubectl set image deployment/frontend frontend="${frontendImage}:${gitSha}" -n smartsplit

        # Add annotation to force rollout with build timestamp
        $timestamp = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
        kubectl patch deployment backend -n smartsplit -p "{`"spec`":{`"template`":{`"metadata`":{`"annotations`":{`"deployment.kubernetes.io/revision-time`":`"$timestamp`"}}}}}"
        kubectl patch deployment frontend -n smartsplit -p "{`"spec`":{`"template`":{`"metadata`":{`"annotations`":{`"deployment.kubernetes.io/revision-time`":`"$timestamp`"}}}}}"
        
    - name: Wait for Rollout
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        kubectl rollout status deployment/backend -n smartsplit --timeout=300s
        kubectl rollout status deployment/frontend -n smartsplit --timeout=300s
        
    - name: Verify Deployment
      shell: powershell -ExecutionPolicy Bypass -NoProfile -Command "& '{0}'"
      run: |
        kubectl get pods -n smartsplit
        Write-Host 'Deployment completed successfully!'